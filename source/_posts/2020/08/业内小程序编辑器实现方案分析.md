---
title: 业内小程序编辑器实现方案分析
date: 2020-08-15 08:00:00
tags:
---

当前, 实现小程序编辑器有以下方案

方案一: 基于 MonacoEditor, 封装文本编辑器在 Electron 中使用
方案一: 启动本地 VS Code 服务器, Electron 中通过 iframe 嵌入网页实现编辑器功能
方案二: 基于 VS Code 完成编辑器功能, 预览功能通过编写 VS Code 插件实现
方案三: 基于 VS Code / Theia 源代码, 定制 IDE(快应用/weex ide/TBE)

各方案优缺点

| 方案名                                                   | 是否便于预览小程序                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | 是否便于构建编辑器                                                                                          | 是否便于部署                                                                                                                 |
| :------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------- |
| Electron + MonacoEditor                                  | ✅ 直接在 Electron 中使用 webview 即可预览小程序,**不需要开发**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | 🚫 MonacoEditor 定制开发困难, 配置繁多,中文文档资源少,**开发成本高**                                        | ✅ 有成熟的 Electron 打包方案, **不需要开发**                                                                                |
| Electron + 通过本地 VS Code 服务进行编辑                 | ✅ 直接在 Electron 中使用 webview 即可预览小程序,**不需要开发**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | ✅ 基于 [code-server](https://github.com/cdr/code-server), 通过 url 传入文件地址即可编辑文件,**不需要开发** | 🚫code-server 不支持 windows 平台.只能通过 docker 进行跨平台部署,但是需要将项目文件映射到 docker 容器内,**部署成本不可接受** |
| VSCode + 通过插件中的 webview 预览                       | 🚫 vscode 中 webview 功能受限, 不能直接发出网络请求,需要由插件进程进行转发,无法接收 cookie.虽然有[Browser Preview](https://github.com/auchenberg/vscode-browser-preview)方案可以, 通过 puppeteer 单独启动一个 chrome 进程绕过 webview 限制. 但它是基于[Chrome DevTools Protocol](https://chromedevtools.github.io/devtools-protocol/tot/Page/#method-startScreencast)的`Page.startScreencast`方法不断获取页面截图, 然后通过 webview 里的 canvas 将浏览器界面同步回 VS Code 中, 同步回来的图片模糊, 响应缓慢.**无法满足实际开发需要**,还是不能接受 | ✅ 直接使用 VS Code 本身作为编辑器,**不需要开发**                                                           | 🕛 不能上架插件市场, 需要开发团队在插件中内置升级检查接口, 由用户主动下载 vsix 文件安装, **部署成本可以接受**                |
| VSCode + 修改源代码,解除 webview 中各种限制,定制开发环境 | 🚫 理论上定制后的项目 webview 可以和 Electron 一致, 但由于需要对 VS Code 整体代码进行修改, **开发成本最高**                                                                                                                                                                                                                                                                                                                                                                                                                                       | ✅ 直接使用 VS Code 本身作为编辑器,**不需要开发**                                                           | 🕛 需要开发团队在项目中内置升级检查接口, 由用户主动下载安装文件, **部署成本可以接受**                                        |

可以看出, 目前没有一个很好的方案, 可以同时满足`不需要订制编辑器`和`不需要开发预览功能`两个需求. 无论哪个方案, 都要进行开发工作.

所以, 如果要开发小程序编辑器, 我们需要在定制 VS Code 和定制 MonacoEditor 之间二选一

# 当前业内方案

| 平台                                                                                                                                                                               | 方案                                                                    | 文件列表中的图标解决方案                                                                                                    |
| :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :---------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------- |
| 微信小程序开发者工具                                                                                                                                                               | 基于 vscode 代码定制小程序编辑器                                        | 通过 vscode 插件`wechat-icon-theme`                                                                                         |
| 字节跳动开发者工具                                                                                                                                                                 | 基于 MonacoEditor 定制编辑器, 编辑器通过 webview 的方式独立引入项目     | 无法进入 webview 查看                                                                                                       |
| 百度开发者工具                                                                                                                                                                     | 基于 MonacoEditor 定制编辑器, 编辑器通过 webview 的方式独立引入项目     | 无法进入 webview 查看                                                                                                       |
| 支付宝(小程序开发者工具)                                                                                                                                                           | 基于 MonacoEditor 定制编辑器, 界面基于 React 渲染, 编辑器是页面的一部分 | 通过 css 样式`小程序开发者工具/resources/app/vol_modules.asar/node_modules/@alipay/volans-source/out/browser/icon/icon.css` |
| [快应用](https://www.quickapp.cn/docCenter/IDEPublicity)/[Weex Studio](https://g.alicdn.com/amte-fe/WEEX-IDE-PAGE/v2/index.html?t=1557792000100)/[TBE](https://isv.taobao.com/ide) | 定制 vscode 源代码                                                      |                                                                                                                             | - |

可以看到, 在基于 Electron 的项目中, 基本都使用了定制`MonacoEditor`的方式. 虽然微信现在使用的是 Electron + vscode 定制版, 但查看微信开发者工具源代码, 能看到微信也是先定制的`MonacoEditor`, 然后才转为定制 vscode

因此, 采用主流方案, 通过 Electron + 定制`MonacoEditor` 实现小程序编辑器, 还是比较稳妥的.

# 花絮

1.  在微信开发者界面, 同时按`ctrl+alt+shift+p`, 然后输入`Preferences:Open User Settings`, 可以看到 VS Code 的配置页面

![微信开发者工具中的vscode配置页](http://ww1.sinaimg.cn/large/6671cfa8ly1ghqnf02e32j213c0sw426.jpg)

2.  微信定制了 vscode 源代码的实锤在`微信web开发者工具\code\package.nw\js\libs\vseditor\bundled\editor.bundled.js`, 打开这个文件, 能看到这是 n 个文件压缩后的结果. 搜索`安装程序文件夹已损坏或与此安装程序版本不兼容。请更正该问题或获取该程序的新副本`, 可以发现, 在[github.com/microsoft/vscode/build/win32/i18n/Default.zh-cn.isl](https://github.com/microsoft/vscode/blob/6c5fa466293c8cb1822ece225c9a907c24c3793a/build/win32/i18n/Default.zh-cn.isl)中有同样的描述
3.  如果使用`MissingWOW64APIs:"你正运行的 Windows 版本不包含安装程序执行 64 位安装所需的功能。要更正此问题，请安装服务包 %1。"`这段话进行判断, 鉴于[2017-04-20 的提交中](https://github.com/microsoft/vscode/blob/b4f8f96d0365aa0c0293d138175e732ba11be06d/build/win32/i18n/Default.zh-cn.isl)还有这段描述, 但在[2018-03-05 的提交里删除了这段描述](https://github.com/microsoft/vscode/blob/12ab70d329a13dd5b18d892cd40edd7138259bc3/build/win32/i18n/messages.zh-cn.isl), 所以可以推测, 微信是基于 2017-04-20~2018-03-05 之间的 vscode 版本进行的定制化
4.  当然也可能正好是微信打包的语言翻译跟过往代码重合了. 从最终界面中看, 微信内的 vscode 版本是相当新的, [2020 年 2 月 7 号](https://zhuanlan.zhihu.com/p/105528000)的时间线功能都有. 还是相当与时俱进的
