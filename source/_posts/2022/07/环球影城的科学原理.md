---
title: [未完成] 环球影城的科学原理
date: 2022-07-16 13:00:00
tags: 一本正经的胡说八道
---

找工作期间去了趟环球影城, 意外发现里边应用不少科学原理, 开篇文章盘(yǘ)点(lè)一下

# 入园篇

我是 10 点半抵达的环球影城, 门口队伍排的绕了一圈, 用了半小时才走到分流检票口.

![待补图: 转圈排队的人群]()

## 科学场景 1: 高并发请求处理

高并发场景指: 短时间内接收大量超出服务能力的请求, 导致出现请求积压. 对于环球影城而言, 当新增待检票用户数高于每分钟最多可检票用户数时, 就会出现请求积压现象. **体现为排队队列快速增长**.

首先第一个问题: 为什么环球影城排长龙对应的模型不是分布式拒绝服务攻击(DDOS/CC 攻击), 而是高并发?

答案比较简单: 虽然 DDOS 和高并发作用机理都是短时间内大量涌入请求导致服务失去响应, 但 DDOS 场景中的请求大部分都是伪造出的无效请求(通过僵尸网络不断发起请求进行攻击), 随机丢掉 99%的攻击包不会有任何心理负担. 而高并发场景下, 请求都是合法请求(春运抢票), 只是因为超出了处理能力导致大部分请求等待时间过长, 形成了停止服务的效果. 在我们的场景中, 显然大部分排队的游客都已经买了票, 只是因为检票能力不足导致门口拥堵, 所以是典型的高并发场景, 而非 DDOS.

对于高并发场景, 有以下核心监控指标:

1.  系统吞吐率:
    1.  QPS/TPS/IOPS: 每秒平均处理请求数/事务数/io 数
    2.  但吞吐率指标有误导性: 100w 个请求, 100s 处理完毕, 然后集中在最后一秒给出响应. 这样算下来每秒平均 QPS 也有 1w/s, 但用户端实际每个请求都等待了 100s, 按正常 Nginx 配置直接 504 超时了, 依然没有用户体验. 所以需要引入新指标
2.  TP 指标(top percentile): 使用 TP 指标表示百分位数据, 例如 TP99 表示大于数据集内 99% 的数据分位点, TP50 表示大于数据集 50%的数据的分位点(中位数). 该指标非常适合反应系统整体响应时长, 常用于系统性能监控场景.

对应于现实场景, 相比平均等待时长, 游客所需排队时间的 99%分位 值显然是更有效的指标
