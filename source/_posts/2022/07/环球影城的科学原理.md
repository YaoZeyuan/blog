---
title: [未完成] 环球影城的科学原理
date: 2022-07-16 13:00:00
tags: 一本正经的胡说八道
---

找工作期间去了趟环球影城, 意外发现里边应用不少科学原理, 开篇文章盘(yǘ)点(lè)一下

# 入园篇

我是 10 点半抵达的环球影城, 门口队伍排的绕了一圈, 用了半小时才走到分流检票口.

![待补图: 转圈排队的人群]()

## 科学场景 1: 高并发请求处理

一般来说, 当短时间内接收大量超出服务能力的请求, 导致出现请求积压时, 我们称之为高并发场景. 对于环球影城而言, 当新增待检票用户数高于每分钟最多可检票用户数时, 就会出现请求积压现象. **体现为排队队列快速增长**. 和普通高并发不一样的是, 在普通高并发场景下, 服务器可以选择直接弃掉部分请求以保证最终指标最优, 但在环球影城场景中, 如果检票人员敢随机宣布部分游客门票作废以试图减少总任务压力的话...肯定会吃官司的侬知道的吧. 所以环球影城面临的不是普通 web 请求, 而是游客提交的**必须被处理**的任务, 此时的理论抽象结果, 应该是操作系统中常见的: 批处理任务模型.

对于批处理任务系统, 一般有以下衡量指标

[批处理任务模型衡量指标](http://tva1.sinaimg.cn/large/007Yq4pTly1h4msu45remj30z40og471.jpg)

而在高并发处理模型中, 比较常见的指标是`系统吞吐率`和`TP`(top percentile)系列. 系统吞吐量包括`QPS`/`TPS`/`IOPS`指标(每秒平均处理请求数/事务数/io 数), 但这些指标存在误导: 比如 100 万个请求, 100 秒处理完毕, 然后集中在最后一秒给出响应. 这样算下来平均每秒可以处理 1 万个请求, 但用户端每个请求都等待了 100s, 就会出现指标酷炫但实际体验非常糟糕的情况. 所以线上一般更偏向使用`TP`指标.

TP(top percentile)指的是百分位数据. TP99 表示大于数据集内 99% 的数据分位点, TP50 表示大于数据集 50%的数据的分位点(中位数). 这个指标非常适合反应系统整体响应时长, 也比较适合衡量环球影城排队的实际情况.

所以, 问题变为: 如何优化系统, 以优化 TP90 的用户排队时间分位值? 我认为可以从这几个方面入手

- 增大缓冲队列确保容纳所有请求
  - 由于所有请求都需要处理, 因此增大缓冲区, 避免任务丢失(等待区满员游客排都排不上)是第一要务. 线上服务可以调整请求缓冲区或使用任务队列承载请求, 线下实体可以通过提前修建排队长廊, 设置栅栏支持队伍折叠以在有限空间中增加尽可能多的排队堆栈长度
  - 该思路在生物中使用较多: 例如在大脑皮层中通过增加沟回提升表面积, 小肠通过增加绒毛提升表面积, 通过折叠增加小肠实际长度等
- 分流增加处理速度
  - 检票作为例常性工作, 只需要`安检`/`验票`两个步骤, 是天然的`无状态`应用, 因此非常适合进行水平扩容. 一台 X 光机一个检票口两个验票人员就相当于一台服务器, 只要场地允许就可以无限累加, 从而加快验票流程
- 人工智能实现实时任务调配
  - 虽然通过增加验票口可以对排队人员实现分流, 但是仍可能出现请求分配不均导致个别检票口任务挤压, 影响 TP90 数值的问题. 这时候就需要实现一套分流体系一边合理安排每个服务器(检票口)的工作量.
  - 对于线上环境, 可以在以下层面进行分流
    - 运营商分流: 移动/联通分配到不同服务器(大区服务器)
    - 地区分流: 通过在地域内配置 DNS 把流量分配到不同节点(山东地区对 baidu.com 的解析结果为 1.1.1.1, 山西地区对 baidu.com 的解析结果为 2.2.2.2)
    - 服务器内分流: 流量首先进入 Nginx 集群, 根据客户端 ip 进行 hash, 分配到不同服务器
      - 确保同一 ip 总被分配到同一服务器
      - 为避免新增服务器改动 hash 总数引起任务重分流, 可以使用[环形 hash 方案](https://segmentfault.com/a/1190000008925205): 先将任务分配到虚拟任务节点中(例如分散到 65535 个虚拟节点上), 然后每个实际服务器承载指定的虚拟节点, 通过新增中间层的方式将用户请求和实际服务进行解耦
        - 计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决, via [Butler Lampson](https://en.wikipedia.org/wiki/Indirection)
  - 但就环球影城的实际场景中, 现场实现一个任务分流器显然难度略高, 所以环球影城最终采取了人工智能解决方案
    - 在排队的终点和 n 个检票口之间添加空地, 让游客在排完队后可以直接观察到每个检票口的实时队伍长度, 从而可以人工判断那个队伍更快, 进而智能将任务调度到该检票口, 实现 TP 指标的最小化
- 其他思路
  - 分流
    - 规定门票最早检票入园时间(类似 12306, 分批放票)
  - 提升硬件性能
    - 配备专业检票人才/使用订制 X 光扫描器自动化发现危险物, 加快单服务器安检任务处理速度
    - 自动化探测的话还有假阳性和假阴性问题, 又是另外一块
  - 预安检
    - 将安检拆分为流水化作业, 由单一安检分为多道工序, 中间划定安全区--次安全区--次次安全区等不同区域, 加快安检流程
    - 亚当斯密有言:扣针的制造大约有 18 道工序, 如果未经过专门的训练, 工人们独自分别工作, 每人每天可能 1 枚针也造不出来.而如果 18 道工序分工由专门的工人担任, 即使是只有 10 人的小工厂, 10 个人每天能制造 4.8 万枚针, 就是每人每天制针 4800 枚.
    - 分工乃提效之源
    - 进阶版的泰罗制在向计算机科学招手
  - 预安检 2
    - 利用信用分作为安检条件, 信用分 400 分以上免安检, 直接减少工作量
    - 相当于利用信用分对任务进行预计算, 使用时直接读取缓存

# 4D 体验篇

环球影城内的娱乐设施可以分为三类

|             | 变形金刚     | 哈利波特       | 侏罗纪公园       |
| :---------- | :----------- | :------------- | :--------------- |
| 拍照打卡类  | 传奇现场     | 奥利凡德魔杖店 | 奇遇迅猛龙       |
| 过山车      | 霸天虎过山车 | 鹰马飞行       |                  |
| 4D 动感体验 | 火种争夺战   | 禁忌之旅       | 侏罗纪世界大冒险 |

PS: 全部场景列表
![全部场景列表](http://tva1.sinaimg.cn/large/007Yq4pTly1h4zqfhuozbj343v2b6x6p.jpg)

拍照打卡类不必多说, 过山车为什么不会掉下来则是高中物理知识, 这里也不再多讲. 但 4D 动感体验类设施是我第一次在国内看到, 有必要分析下.

## 科学场景 2: 运动的错觉与惯性系

4D 体验类最为人称道的, 就是让游客感到自己真的在快速飞行(火种争夺战中的高速赛车/禁忌之旅的魁地奇飞行/侏罗纪大冒险中霸王龙的追逐). 但娱乐设施并不大, 也没有感受到高速移动带来的迎风的感觉, 这是怎么回事?

答案当然是游客并没有动, 但游客感受到了自己在高速移动. 所以问题转化成了: 如何在让游客本身不移动的情况下, 感受到自己在快速移动? 或者换一种问法: 人类为什么会认为自己在移动?



## 科学场景 3: 优速通的博弈
