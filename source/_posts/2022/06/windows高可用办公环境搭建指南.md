---
title: windows高可用办公环境搭建指南
date: 2022-06-24 13:00:00
tags: 科普
---

# 文章目标

| 文章假设 | 说明                                                                                                                                                                                                                                                     |
| :------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 目标人群 | 非 IT 专业人士, 包括不限于科研/财务/医生/律师等以 windows 为办公环境, 但没有编程经验的人群                                                                                                                                                               |
| 任务目标 | 通过且仅通过阅读文章, 完成高可用 windows 办公环境的构建                                                                                                                                                                                                  |
| 完成效果 | 1. 假设 D 日 12:00 电脑丢失, 且本人在国内其他城市出差, 身边无任何资料备份(但当地网络情况良好, 资料总体积不大于 300G)<br/>2. D 日 14:00 完成新电脑购买后, D 日 17:00 在新电脑中完成基本数据恢复, 支持正常办公. D+1 日 8:00 完成数据整体恢复, 与旧电脑无异 |
| 任务成本 | 1. win10 及以上操作系统, 需打开自动更新<br/>2. 电脑本身流畅不卡顿<br/>3. Microsoft 365 订阅一份(家庭版 498 元/年, 最多支持 6 个账号同时使用, 但不建议非家庭成员间共享账号)                                                                               |

# 实现原理

`基本问题: 为什么数据丢失会造成损失`

数据丢失损失大是因为数据本身没有备份导致. 如果数据有备份, 那么丢失后只要从备份中恢复即可.

`进阶: 假设需要备份, 应该备份到哪里?`

备份服务需要满足以下要求:

1. 备份方便, 最好随时备份
2. 还原方便, 最好在任意时间任意地点均可还原
   1. 针对要求 2
   2. 排除 Dropbox 等国外服务(使用不稳定, 可能需要科学上网支持)
3. 数据安全, 私密信息不可被非本人以外的人查看, 已备份数据不可丢失.
   1. 针对要求 3
   2. 首先排除百度网盘(无法保障个人文件安全, 个人数据一旦被误判为非法文件会被直接删除),
   3. 然后排除小公司(无法保证持续经营)
   4. 排除自建备份服务(无法保证可靠性, 做不到多数据中心备份的话, 一次地震/火灾直接全毁)
4. 进阶: 数据还原期间, 可以逐步恢复数据. 先恢复必要数据保障日常工作生活正常使用, 非常用内容可以后台逐步恢复.
   1. 可以理解为将需要的数据文件视为占位符, 只在访问文件时才从互联网上将该文件下载下来. 需要操作系统底层支持
   2. 针对要求 4
   3. 排除 mac(有针对整个磁盘备份的时光机功能, 但恢复期间不能进入系统, 只有全部恢复完毕才可以恢复)
   4. 排除非 windows 官方提供的云盘(非官方云盘无法实现该要求)
      1. 如果弱化该要求, 只希望针对 office 文件进行备份, 可以选择金山云盘, 默认所有办公文件均保留在金山云盘中, 也可以使用 wps 在线版进行办公
5. 进阶 2: 数据还原后, 希望电脑使用体验和原设备一模一样, 或者所有开启了自动同步的电脑使用体验都一样. 具体要求为:
   1. 安装应用软件后, 之前配置的应用软件设置仍在且一模一样
   2. 电脑桌面上的文件和原电脑保持一致, 所有希望备份的文件内容均在原有位置
   3. 说明: 要求 5 可以实现, 且成本非常低, 只需要遵守默认约定即可. 具体方案见`实施步骤`一节
6. 进阶 3: 恢复数据只在硬件丢失情况下执行
   1. 本地重装系统后, 只需要安装应用软件, 不必重新恢复数据

# 实施步骤

根据需求 1-4, 我们排除了非微软官方云盘`OneDrive`之外的所有备份方案, 又因为需要实现目标 4: 恢复数据期间不影响正常工作, 因此需要`win10`及以上平台. 因此后续流程以`win10`+`OneDrive`为底层环境进行展开. `OneDrive`本身不对外售卖, 只和`Office家庭版`一起提供, 因此假设已经购买了`Microsoft 365 家庭版`, 并有了微软账号

开启备份的第一步是登录账号, 以便将数据保存到云服务中

## 登录系统层微软账号

win10 安装成功后, 会要求登录 Microsoft 账号, 普通用户一般会选择跳过改为使用本地账号, 导致失去同步能力(登录微软账号后默认送 5GB 的免费同步空间). 考虑到买`Microsoft 365 家庭版`时一定有微软账号, 因此可以直接在系统中登录.

登录步骤为:

- 进入`设置`界面, 选择`账户`
  - ![设置界面](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jd271zfkj20x60pt0vo.jpg)
- 在`账户信息`标签中, 点击改为 Microsoft 账户登录
  - ![登录](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jd3co4mjj20x60pt46u.jpg)

## 登录 Onedrive 云盘账号, 并配置云盘在本地的位置

- 打开开始菜单, 直接输入 OneDrive, 可以找到内置的 OneDrive 应用. 点击应用
  - ![启动OneDrive](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jd6b9cyuj20w017gh7h.jpg)
- 启动后会要求用户登录 OneDrive, 正常登录
  - ![登录OneDrive](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jd7tt8n5j20on0n9n0p.jpg)
- 登录成功后, **需要配置 OneDrive 在本地的位置.**
  - 为了实现目标 6: 只有电脑丢失时才需要恢复备份, 重装系统时不需要恢复. 我们需要将 OneDrive 存储位置和系统分开. 一般选择 C 盘作为系统盘, **而将 OneDrive 放在 D 盘上**. 这样, 重装系统时只需要格式化 C 盘, 重装之后由于 D 盘数据本身还在, 我们只需要重新登录 OneDrive, 并指定 D 盘为存储路径, OneDrive 会自动将`D:/onedrive`目录下文件和云端文件并进行更新----由于大部分文件都没有变动过, 因此也就不需要重新下载, 我们也就可以跳过数据恢复的过程
  - 登录成功
    - ![登录成功](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jdb9sh96j20op0n9jw1.jpg)
  - 将 OneDrive 存储地址设为`D:/onedrive`
    - ![配置onedrive路径](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jdiad9scj213r0mcn7e.jpg)
  - 提示该目录下已经有同名文件夹, 是否仍要使用----当然回答是
    - ![提示该目录下已经有同名文件夹](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jditd8aej20om0n6af9.jpg)
  - 最终结果
    - ![最终结果](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jdk0k9zfj20op0n742z.jpg)
- 登录完成后要求选择需要同步的内容
  - 建议选择`全部同步`
  - OneDrive 提供了配置项以实现要求 4: 渐进式同步, 同步期间不干扰正常工作. 后续会提到配置方法
  - ![选择需要同步的内容](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jdo7yo2xj20oq0nbagp.jpg)
- 此后是简单的功能说明, 一路下一步最后关闭窗口即可
  - ![功能说明](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jdpk0qrhj20om0n9n0z.jpg)

## 配置桌面/图片/文档的自动同步

登录完成后如果本地已有 OneDrive 文件夹, OneDrive 会自动在后台进行比较, 作为同步中的状态, icon 为`云+小圆圈`的样式, 让其在后台进行自动对比即可

![OneDrive自动对比更改](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jdtnw94qj20f60ry40e.jpg)

然后是重头戏 => 实现需求 5: 数据还原后, 电脑体验和原设备一模一样, 如果有多台设备, 只要登录同一账号, 不同设备间的体验也一模一样.

先说实现方法, 然后再介绍原理:

### 多设备保持体验一致的实现方法

- 打开 OneDrive 设置界面
  - ![打开 OneDrive 设置界面](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jessj2mxj20f40rv78t.jpg)
- 选择`备份`标签, 然后点击`管理备份`按钮
  - ![选择`备份`标签, 然后点击`管理备份`按钮](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jexa7t3oj20hg0lljuk.jpg)
- 勾选`桌面`/`文档`/`图片`三个文件夹, 选择开始备份
  - ![配置备份目录](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jeyyov7sj20ol0n7q81.jpg)
- 随后会自动执行备份
  - ![操作结果](http://tva1.sinaimg.cn/large/6671cfa8gy1h3jezz379pj20oo0ncq9c.jpg)

通过这个步骤, 可以将`桌面`/`文档`/`图片`中的内容进行备份. 如果满足以下两个要求, 就可以完美实现需求 5: `数据还原后, 希望电脑使用体验和原设备一模一样, 或者所有开启了自动同步的电脑使用体验都一样`

1.  如果文件需要备份, 则统一放在`文档`下的一个目录中(例如可以起名叫`同步盘`)
2.  安装任何需要同步的应用程序时, 不选择安装位置, 而是一路下一步, 使用默认配置(微信/企业微信/QQ 需要额外操作, 后边会说明)

解释一下原理:

#### 跨设备文件同步原理

对于所有需要同步的文件统一放在`文档`目录下, 这个原因比较简单: 因为`文档`文件夹会被 OneDrive 自动同步, 因此文件夹内的`需同步文件`自然也会被同步.

又因为各个设备上 OneDrive 本地文件夹所在的路径一样(都是`D:/`盘下的`onedrive`文件夹), 所以不管哪台电脑, 都可以按相同路径找到对应文件

#### 跨设备应用程序同步原理

应用程序分为两个部分:

1.  `程序本体`
2.  应用程序的`配置文件`/`数据库文件`

我们对应用程序所做的任何修改, 都会被储存到`配置文件`/`数据库文件`中. 只要配置文件相同, 应用程序的行为也一定相同.

而一路`下一步`安装时, 由于我们走的是默认安装流程, 所以`配置文件`/`数据库文件`也会被放在默认的位置下, 也就是`文档`文件夹中

而我们又已经配置了`文档`文件夹的自动同步功能

所以, 即使重装了系统, 我们也只要重新安装一遍应用程序, 把`程序本体`补上, 程序启动后发现`文档`下已经有了(之前备份好了的)`配置文件`, 会直接基于(根据备份还原出的)`配置文件`启动, 其表现自然也和备份时一样.

#### 跨设备同步应用程序配置时需要注意的事

这个太重要以至于需要单拉出来说一下:

跨设备同步应用程序配置对于绝大多数应用都可以使用, 但个别应用例外:

1.  配置/数据库文件内容巨大且经常变的应用
    1.  例如: 微信/企业微信/QQ. 他们会把聊天图片和聊天中接收的文件也放在`文档`文件夹下, 快速耗尽 OneDrive 容量. 因此需要将他们从 OneDrive 中移出来.
    2.  我的解决方案是:
        1.  在`D盘`下, 创建`tencent_wechat`文件夹, 里边分别创建`wechat`/`wework`/`qq`三个文件夹, 专门放他们三个的聊天记录.
        2.  微信配置方法
            1.  ![微信配置方法-1](http://tva1.sinaimg.cn/large/6671cfa8ly1h3jmqz3loaj20ag076wg5.jpg)
            2.  ![微信配置方法-2](http://tva1.sinaimg.cn/large/6671cfa8ly1h3jmp3sxhuj20o80rh45x.jpg)
        3.  企业微信配置方法
            1.  ![企业微信配置方法-1](http://tva1.sinaimg.cn/large/6671cfa8ly1h3jmsm1oarj20hg0h6q6d.jpg)
            2.  ![企业微信配置方法-2](http://tva1.sinaimg.cn/large/6671cfa8ly1h3jmu2899dj20xc0ncjxr.jpg)
        4.  QQ 配置方法
            1.  ![QQ配置方法-1](http://tva1.sinaimg.cn/large/6671cfa8ly1h3jmxb5mj9j20bt0hjq5e.jpg)
            2.  ![QQ配置方法-2](http://tva1.sinaimg.cn/large/6671cfa8ly1h3jmzclsepj20t50l87bv.jpg)
2.  会产生大量零散文件, 且这些文件经常变动且都有用处的应用
    1.  这条针对的是程序员, 不能将 git 仓库(.git 目录中有大量小文件)/前端项目(有 node_modules 目录)放在自动同步中, 否则漏了两个, 或者删除文件后 OneDrive 主动帮你还原回来导致代码启动不了, 都很麻烦

### 渐进式数据还原----数据还原期间保持电脑可用的方案

目前除 4 以外的所有要求均已实现, 只剩下这一个需求, 怎么处理呢? 答案是勾选 OneDrive 上的一个选型

![按需同步](http://tva1.sinaimg.cn/large/6671cfa8ly1h3jn3ubizsj20hk0lljuw.jpg)

当勾选按需同步时, OneDrive 只会创建文件占位符, 不会真实下载文件. 该功能主要在第一次恢复数据时使用, 或者当硬盘容量不够时使用(通过不同步照片/视频的方式节约硬盘空间). 勾选该选项后, 默认不会下载源文件, 只有当用户真实访问文件时才会去下载.

建议是紧急情况下在使用, 正常来说, 300G 的内容, 一晚上也足够全同步下来了.

# 其他

除了系统文件, 还有一些其他的数据需要同步. 我使用的是下边的方案, 仅供参考:

1.  浏览器使用 chrome, 并登录 Google 账号. 这样所有的`收藏夹`/`访问记录`/`浏览器插件`都会被保存在谷歌服务器上. 可以自动同步
    1.  对于普通用户而言, 需要同步浏览器数据可以使用两种方案
        1.  win10 之后系统内置了 Edge 浏览器, 可以视为国内可用的 chrome(是微软团队基于 chrome 开发出的浏览器产品), 登录微软账号后也可以同步`收藏夹`/`访问记录`/`浏览器插件`内容
        2.  使用国产浏览器, 例如 360 浏览器, 登录账号后也可以进行同步
2.  **系统安全**
    1.  虽然可以信任微软本身不会查阅我们的数据, 但把数据全同步在 OneDrive 上也就意味着一旦微软账号被盗, 盗号者本身也能拿到云盘中所有的文件. 所以必须保护好微软账号.
    2.  我的做法是:
        1.  微软账号单设一个密码, 只在这一个地方使用, 其他地方**绝对不用相同或类似密码**
        2.  其他密码统一用密码管理软件(keepass)生成, 使用 OneDrive 同步密码数据库文件. 密码数据库也有一个独立的密码, 同样也是只在这一个地方使用, 其他地方**绝对不用相同或类似密码**
        3.  这样, 由于微软账号安全, 所以文件安全
        4.  由于其他软件密码由密码数据库生成, 又因为文件安全&管理密码所以密码文件本身不会外泄, 所以其他软件也安全.
3.  版本控制
    1.  对于任意备份的文件, OneDrive 默认保留 30 天内的所有版本修改. 可以还原到其中的任意一个版本. 这个时间范围足够日常使用了
        1.  示例:
            1.  ![版本历史示例](http://tva1.sinaimg.cn/large/6671cfa8ly1h3jnj1d2ddj20t60tuk6a.jpg)

预祝各位永远用不到恢复功能~
